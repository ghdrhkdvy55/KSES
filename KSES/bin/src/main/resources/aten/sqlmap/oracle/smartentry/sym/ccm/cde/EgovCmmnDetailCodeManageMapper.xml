<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kses.backoffice.bas.code.mapper.EgovCmmnDetailCodeManageMapper">
	<select id="selectCmmnDetailCodeListByPagination" resultType="lmap">
		SELECT R.* FROM
		(
			SELECT 
				SUM(1) OVER(PARTITION BY NULL) AS TOTAL_RECORD_COUNT,
				ROW_NUMBER() OVER (ORDER BY A.CODE DESC) AS RNUM, 
				A.CODE_ID, B.CODE_ID_NM, A.CODE, A.CODE_NM, A.CODE_DC, A.USE_AT, A.CODE_ETC1, A.CODE_ETC2,
				TO_CHAR(A.LAST_UPDT_PNTTM, 'yyyy-mm-dd') AS LAST_UPDT_PNTTM, A.LAST_UPDUSR_ID
			FROM COMTCCMMNDETAILCODE A
			     INNER JOIN COMTCCMMNCODE B ON A.CODE_ID = B.CODE_ID				     
			WHERE B.USE_AT = 'Y'
		    AND B.CODE_ID = #{codeId}					
		) R
		WHERE 1=1
		ORDER BY CAST(REPLACE(CODE, CONCAT(CODE_ID, '_'), '') AS INT) ASC
	</select>
	
	<select id="selectCmmnDetailCodeDetail" resultType="CmmnDetailCode">
		SELECT 
			C.CL_CODE AS clCode, C.CL_CODE_NM AS clCodeNm, B.CODE_ID AS codeId, B.CODE_ID_NM AS codeIdNm , A.CODE AS code, 
			A.CODE_NM AS codeNm, A.CODE_DC AS codeDc, A.USE_AT AS useAt
		FROM COMTCCMMNDETAILCODE A
		     INNER JOIN COMTCCMMNCODE B ON A.CODE_ID = B.CODE_ID
		     INNER JOIN LETTCCMMNCLCODE C ON B.CL_CODE = C.CL_CODE
		WHERE A.CODE_ID = #{value}
	</select>
	
	<select id="selectCmmnDetailCombo" resultType="lmap">
		SELECT 
			A.CODE AS code, A.CODE_NM AS codeNm, A.CODE_DC AS codeDc, A.USE_AT AS useAt
		FROM COMTCCMMNDETAILCODE A		    
		WHERE A.CODE_ID = #{code}
		ORDER BY CAST( REPLACE(CODE, CONCAT(CODE_ID, '_'), '') AS INT) ASC
	</select>
	
	<!-- 신규 추가 -->
	<select id="selectCmmnDetailComboLamp" resultType="lmap">
		SELECT 
			A.CODE AS code, A.CODE_NM AS codeNm, A.CODE_DC AS codeDc, A.USE_AT AS useAt
		FROM COMTCCMMNDETAILCODE A		    
		WHERE A.CODE_ID = #{code}
	</select>
	<!--  2021-11-11 수정 -->
	<select id="selectCmmnDetail" resultType="lmap">
		SELECT A.CODE,  A.CODE_NM, A.CODE_DC, A.CODE_ETC1, A.CODE_ETC2, A.USE_AT, A.CODE_ID
		FROM COMTCCMMNDETAILCODE A		    
		WHERE A.CODE = #{code}
	</select>
	
	<select id="selectCmmnDetailComboEtc" resultType="CmmnDetailCode">
		SELECT  
			A.CODE AS code, A.CODE_NM AS codeNm, A.CODE_DC AS codeDc, A.USE_AT AS useAt
		FROM COMTCCMMNDETAILCODE A		    
		WHERE A.CODE_ID = #{params.code}
		<if test="!@org.apache.commons.lang3.StringUtils@isEmpty(params.nowData)">
			<![CDATA[
			AND REPLACE(A.CODE_NM, ':','') >= #{params.nowData}
			]]>
		</if>
		<if test="!@org.apache.commons.lang3.StringUtils@isEmpty(params.overData)">
			<![CDATA[
			AND REPLACE(A.CODE_NM, ':','') > #{params.overData}
			]]>
		</if>
		<if test="!@org.apache.commons.lang3.StringUtils@isEmpty(params.startCode) and !@org.apache.commons.lang3.StringUtils@isEmpty(params.endCode)">
			AND CAST(CODE_DC AS int) BETWEEN  REPLACE(#{params.startCode}, CONCAT(#{params.code},'_'), '')  AND REPLACE(#{params.endCode}, CONCAT(#{params.code},'_'), '')
		</if>
		<if test="!@org.apache.commons.lang3.StringUtils@isEmpty(params.notIn)">
			AND A.CODE_NM NOT IN 
			<foreach collection="params.notlist" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="!@org.apache.commons.lang3.StringUtils@isEmpty(params.notSearch)">
			AND REPLACE(a.CODE_NM, ':','') NOT LIKE CONCAT('%',#{params.notSearch})
		</if>
			AND	USE_AT ='Y'
		
		<choose>
		   	<when test="!@org.apache.commons.lang3.StringUtils@isEmpty(params.startCode) and !@org.apache.commons.lang3.StringUtils@isEmpty(params.endCode)">
		       ORDER BY CAST(CODE_DC AS INT) ASC
		   	</when>
			<otherwise>
				ORDER BY CODE ASC
		   	</otherwise>
		</choose>
	</select>
    
    <select id="selectCmmnDetailResTypeCombo" resultType="CmmnDetailCode">
		SELECT 	A.CODE AS code, A.CODE_NM AS codeNm, A.CODE_DC AS codeDc, A.USE_AT AS useAt 
		FROM COMTCCMMNDETAILCODE A 
		WHERE A.CODE_ID = #{codeId}
		<if test="searchCodedc != ''">
			AND A.CODE_DC = #{searchCodedc}
		</if>
			AND A.USE_AT ='Y' 
	</select>	
	
	<insert id="insertCmmnDetailCode">
		<![CDATA[
		INSERT INTO COMTCCMMNDETAILCODE
		(
			CODE_ID, CODE, CODE_NM, CODE_DC, USE_AT, CODE_ETC1, CODE_ETC2, FRST_REGIST_PNTTM, FRST_REGISTER_ID, LAST_UPDT_PNTTM, LAST_UPDUSR_ID
		)
		VALUES
		(
		
			#{codeId}, KSES_USER.FN_DETAIL_CODEID(#{codeId}) , #{codeNm}, 
			#{codeDc,jdbcType=VARCHAR}, 'Y', #{codeEtc1, jdbcType=VARCHAR}, #{codeEtc1, jdbcType=VARCHAR},
			SYSDATE, #{lastUpdusrId,jdbcType=VARCHAR},
			SYSDATE, #{lastUpdusrId,jdbcType=VARCHAR}
		)
		]]>
	</insert>
	
	<update id="updateCmmnDetailCode">
	    <![CDATA[
		UPDATE COMTCCMMNDETAILCODE SET CODE_NM = #{codeNm}, 
		                               CODE_DC = #{codeDc, jdbcType=VARCHAR}, 
		                               CODE_ETC1 = #{codeEtc1, jdbcType=VARCHAR}, 
		                               CODE_ETC2 = #{codeEtc2, jdbcType=VARCHAR}, 
		                               USE_AT = #{useAt}, 
		                               LAST_UPDUSR_ID = #{lastUpdusrId,jdbcType=VARCHAR},
		                               LAST_UPDT_PNTTM = SYSDATE
		WHERE CODE = #{code}
		]]>
	</update>
	
	<delete id="deleteCmmnDetailCode">
		DELETE FROM COMTCCMMNDETAILCODE WHERE CODE = #{value}
	</delete>
	
	<delete id="deleteCmmnDetailCodeId">
		DELETE FROM COMTCCMMNDETAILCODE WHERE CODE_ID = #{value}
	</delete>
</mapper>